<?xml version="1.0"?>
<launch>

  <!-- Camera parameters -->
  <arg name="serial_no"                 default="" />
  <arg name="sensor_name"               default="camera" />
  <arg name="rgb_camera_info_url"       default="" />
  <arg name="intermediate_topic"        default="/detector/skeletons" />
  <arg name="ground_from_calibration"   default="false" />
  <arg name="rtpose_skeletons_enabled"	default="true" />
  <arg name="use_coco"                  default="true" />

  <!-- Launch pose estimator node based on rtpose -->
  <group if="$(arg rtpose_skeletons_enabled)" >
    <node pkg="rtpose_wrapper" type="rtpose" name="rtpose_$(arg sensor_name)" output="screen" respawn="true">

      <rosparam command="load"                        file="$(find rtpose_wrapper)/conf/kinect2_params.yaml" />

      <!-- COCO -->
      <param name="caffe_model" value="$(find rtpose_wrapper)/model/mpi/pose_iter_150000.caffemodel"       if="$(arg use_coco)"/>
      <param name="caffe_proto" value="$(find rtpose_wrapper)/model/mpi/pose_deploy_linevec_64.prototxt"   if="$(arg use_coco)"/>

      <!-- MPI -->
      <param name="caffe_model" value="$(find rtpose_wrapper)/model/mpi/pose_iter_160000.caffemodel"   unless="$(arg use_coco)"/>
      <param name="caffe_proto" value="$(find rtpose_wrapper)/model/mpi/pose_deploy_linevec.prototxt"  unless="$(arg use_coco)"/>
      <param name="head_joint_enhancement" value="true"                                                unless="$(arg use_coco)"/>

      <param name="depth_topic"       value="/$(arg sensor_name)/aligned_depth_to_color/image_raw"/>
      <param name="rgb_topic"         value="/$(arg sensor_name)/color/image_rect_color"/>
      <param name="camera_info_topic" value="/$(arg sensor_name)/color/camera_info" />

      <remap from="/detector/skeletons"	     to="$(arg intermediate_topic)" />
      <remap from="/detector/skeleton_image"   to="/$(arg sensor_name)/skeleton_image" />
      <remap from="/detector/skeletons_depth_image" to="/$(arg sensor_name)/skeleton_depth_image" />

    </node>
  </group>

  <!-- Launch pose estimator node based on OpenPose -->
  <group unless="$(arg rtpose_skeletons_enabled)" >
    <include file="$(find openpose_wrapper)/launch/opw_default.launch" >
      <arg name="opw_node_required"             value="true"             />
      <arg name="node_name"                     value="$(arg sensor_name)" />

      <!-- These parameters MUST be overriden following system configuration -->
      <arg name="models_path"                   value="$(find openpose_wrapper)/models" />
      <arg name="input_image_topic"             value="/$(arg sensor_name)/color/image_rect_color"   />

      <!-- These parameters CAN be overriden, feel free to place just what you need to modify -->
      <arg name="publish_rendered_image_topic"  value="true"                  />
      <arg name="publish_compressed"            value="false"                 />
      <arg name="output_image_topic_name"       value="openpose_detection"    />
      <arg name="publish_skeleton_group_topic"  value="true"                  />
      <arg name="out_msg_topic_name"            value="skeleton_group"        />
      <arg name="use_region_of_interest"        value="true"                  />
      <arg name="roi_top_left_corner_x"         value="50"                   />
      <arg name="roi_top_left_corner_y"         value="50"                    />
      <arg name="roi_width"                     value="540"                   />
      <arg name="roi_height"                    value="380"                   />
      <arg name="min_skeleton_confidence"       value="0.2"                   />
      <arg name="min_marker_confidence"         value="0.4"                   />
      <arg name="enable_marker_filtering"       value="false"                 />
      <arg name="lag_minimization_enable"       value="true"                  />
      <arg name="max_input_delay"               value="0.1"                   />

      <!-- OpenPose specific parameters, add here below what you need to override -->
      <arg name="body_render_threshold"         value="0.4"                   />
      <arg name="body_enable_detection"         value="true"                  />
      <arg name="hands_enable_detection"        value="false"                 />
      <arg name="face_enable_detection"         value="false"                 />
    </include>

    <include file="$(find openpose_wrapper)/launch/opw_3d_default.launch" >
      <arg name="opw_3d_node_required"                    value="true"                                                  />
      <arg name="node_name"                               value="$(arg sensor_name)"                                    />
      <arg name="in_skeleton_group_topic"                 value="/opw/$(arg sensor_name)/skeleton_group"                />
      <arg name="in_depth_topic"                          value="/$(arg sensor_name)/aligned_depth_to_color/image_raw"  />
      <arg name="in_camera_info_topic"                    value="/$(arg sensor_name)/color/camera_info"                 />
      <arg name="publish_in_global_reference_frame"       value="false"                                                 />
      <arg name="global_reference_frame"                  value="world"                                                 />
      <arg name="enable_bounding_box"                     value="false"                                                 />
      <arg name="depth_to_meters_multiplier"              value="0.001"                                                 />
    </include>

  </group>

</launch>
